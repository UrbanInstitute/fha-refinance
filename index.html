<!DOCTYPE html>

<meta charset="utf-8">
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/main.css">
<body>
  <div id = "controls">
    <strong>FHA Rate:</strong><div class = "value-wrapper"><span id="rate-value"></span></div>
    <strong>Premium:</strong><div class = "value-wrapper"><span id="premium-value"></span></div>
      <input type="range" id="rate" min = "3" max = "5" step = ".01" name="rate" value = "3.66">
      <input type="range" id="premium" min = ".85" max = "1.35" step = ".5" name="premium" value = ".85">
  </div>
  <strong>0.5 Spread:</strong><div class = "spread-wrapper"><span id="s50-value"></span></div>
  <strong>0.75 Spread:</strong><div class = "spread-wrapper"><span id="s75-value"></span></div>
  <strong>1.0 Spread:</strong><div class = "spread-wrapper"><span id="s100-value"></span></div>


<script>

var margin = {top: 20, right: 50, bottom: 30, left: 100},
      width = 560 - margin.left - margin.right,
      height = 300 - margin.top - margin.bottom;

  var x = d3.scale.ordinal()
      .rangeRoundBands([0, width], .1);

  var y = d3.scale.linear()
      .range([height, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .ticks(10, "");

  x.domain(["spread .50","spread .75","spread 1"]);
  y.domain([0, 7000000]);

  var sampleSize = 6600000
  var excluded =   2200000

  var svg = d3.select("body").append("svg")
      .attr("class","graph")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");




d3.tsv("data/data.tsv", function(d) {
  return {
    rate: +d.Refinance_Note_Rate,
    premium: +d.Annual_Premium,
    spread: +d.Spread,
    estimate: +d.Refi_Volume_Estimate.replace(/,/g,'')
    };
  }, function(error, data) {

    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    var ytest = svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

  	function bars(rate,premium){
  	  // var s75
  	  // var s1
  	  var rate = parseFloat(rate);
  	  var premium = parseFloat(premium);

  	  rate = roundRate(rate);

      var s50 = estimate(rate,premium,.5)
      var s75 = estimate(rate,premium,.75)
      var s100 = estimate(rate,premium,1)

      var tmp = [{s50:s50,s75:s75,s100:s100}]


  	  d3.select("#rate").value = rate

  	  d3.select("#rate-value").text(rate);
  	  d3.select("#premium-value").text(premium);
      d3.select("#s50-value").text(s50);
      d3.select("#s75-value").text(s75);
      d3.select("#s100-value").text(s100)



  	  // percentIn = parseFloat(inp);

  	  d3.selectAll('.bar').remove();

  	  // var lowerBound = parseFloat((100.0 - 2*percentIn) / (100.0 - percentIn));

  	  
  	  // d3.tsv("data.tsv", type, function(error, data) {



  	    var bars = svg.selectAll(".bar")
  	      .data(tmp);

        // bars.enter()


  	    bars.enter().append("rect")
  	        .attr("class", "bar benefit")
  	        .attr("x", x("spread .5"))
  	        .attr("height",   function(d){return height - y(d.s50);})
  	        .attr("width", x.rangeBand())
  	        .attr("y",  function(d){return y(d.s50+excluded);})


        bars.enter().append("rect")
            .attr("class", "bar benefit")
            .attr("x", x("spread .75"))
            .attr("height",   function(d){return height - y(d.s75);})
            .attr("width", x.rangeBand())
            .attr("y",  function(d){return y(d.s75+excluded);})

        bars.enter().append("rect")
            .attr("class", "bar benefit")
            .attr("x", x("spread 1"))
            .attr("height",   function(d){return height - y(d.s100);})
            .attr("width", x.rangeBand())
            .attr("y",  function(d){return y(d.s100+excluded);})

        bars.enter().append("rect")
            .attr("class", "bar other")
            .attr("x", x("spread .5"))
            .attr("height", function(d){return height -y(sampleSize - d.s50 - excluded);})
            .attr("width", x.rangeBand())
            .attr("y", y(sampleSize) )

        bars.enter().append("rect")
            .attr("class", "bar other")
            .attr("x", x("spread .75"))
            .attr("height", function(d){return height -y(sampleSize - d.s75 - excluded);})
            .attr("width", x.rangeBand())
            .attr("y", y(sampleSize) )

        bars.enter().append("rect")
            .attr("class", "bar other")
            .attr("x", x("spread 1"))
            .attr("height", function(d){return height -y(sampleSize - d.s100 - excluded);})
            .attr("width", x.rangeBand())
            .attr("y", y(sampleSize) )


        bars.enter()
            .append("rect")
            .attr("class", "bar excluded")
            .attr("x", x("spread .75"))
            .attr("height", height - y(excluded))
            .attr("width", x.rangeBand())
            .attr("y", y(excluded))

        bars.enter()
            .append("rect")
            .attr("class", "bar excluded")
            .attr("x", x("spread .5"))
            .attr("height", height - y(excluded))
            .attr("width", x.rangeBand())
            .attr("y", y(excluded))

        bars.enter()
            .append("rect")
            .attr("class", "bar excluded")
            .attr("x", x("spread 1"))
            .attr("height", height - y(excluded))
            .attr("width", x.rangeBand())
            .attr("y", y(excluded))


  	    // var barUpdate = d3.transition(bars)
  	    //   .transition().duration(500)
  	    //   .attr("height", function(d) { return height - y(s50); })
  	    //   .attr("y", function(d) { return y(s50); });

	  // });

	}

	d3.select("#rate").on("input", function() {
  bars(+this.value, d3.select('#premium')[0][0].value);
});

d3.select("#premium").on("input", function() {
  bars(d3.select('#rate')[0][0].value,+this.value);
});

bars(3.66,.85);


function estimate(rate,premium,spread){
	var value = $.grep(data, function(obj){
		return obj.rate == rate && obj.premium == premium && obj.spread == spread
	});
  return value[0].estimate
}
function roundRate(rate){
	 if(rate > 3.58 && rate < 3.705){
	 	return 3.66
	 }
	 else{
		return (Math.round(rate * 4) / 4).toFixed(2);
	 }
}

function type(d) {
  d.value = +d.value;
  return d;
}




});





// when the input range changes update value 


// jQuery(document).ready(function($) {
// //Set default open/close settings
// $('.acc_container').hide(); //Hide/close all containers

//     //On Click
// $('.acc_trigger').click(function(){

//   if ($(this).hasClass('active')){
//     $('.acc_trigger').removeClass('active').next().slideUp();
//   }

//  else{
//     $(this).addClass('active').next().slideDown();
//     // return false; //Prevent the browser jump to the link anchor
// }

// });

// $('.acc_trigger_arrow').click(function(){

//   if ($(this).hasClass('active')){
//     $('.acc_trigger_arrow').removeClass('active');

//     $('.acc_container').slideUp();
//   }

//  else{
//     $('.acc_trigger_arrow').addClass('active');

//     $('.acc_container').slideDown();

//     // return false; //Prevent the browser jump to the link anchor
// }

// });

    

    

// });



</script>
</body>
</html>